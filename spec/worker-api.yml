openapi: 3.0.1
info:
  title: Caddy Delivery Network - Worker API
  version: 0.0.0
servers:
  - url: /api/worker
paths:
  /health:
    get:
      tags:
        - health
      summary: health check
      operationId: healthCheck
      responses:
        200:
          description: Success
        500:
          description: Internal server error

  /{id}/heartbeat:
    get:
      tags:
        - worker
      summary: heartbeat event
      security:
        - TokenAuth: []
      operationId: heartbeat
      parameters:
        - $ref: '#/components/parameters/id'
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  config_updated_at:
                    $ref: "#/components/schemas/timestamp"
                  files_updated_at:
                    type: array
                    items:
                      type: object
                      properties:
                        path:
                          type: string
                        updated_at:
                          $ref: "#/components/schemas/timestamp"
        404:
          description: No such instance (deleted or token mismatch)

  /{id}/config:
    get:
      tags:
        - worker
      summary: get config
      security:
        - TokenAuth: []
      operationId: getConfig
      parameters:
        - $ref: '#/components/parameters/id'
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  updated_at:
                    $ref: "#/components/schemas/timestamp"
                  content:
                    type: string
                    description: Caddyfile
        404:
          description: No such instance (deleted or token mismatch)
  /{id}/file:
    get:
      tags:
        - worker
      summary: get single file
      security:
        - TokenAuth: []
      operationId: getFiles
      parameters:
        - $ref: '#/components/parameters/id'
        - in: header
          name: X-File-Path
          description: Path of target file
          schema:
            type: string
      responses:
        200:
          description: Success
          headers:
            X-Updated-At:
              description: Update timestamp of target file
              schema:
                $ref: "#/components/schemas/timestamp"
          content:
            application/octet-stream: # binary
              schema:
                type: string
                format: binary
        404:
          description: No such instance (deleted or token mismatch) or file

components:
  securitySchemes:
    TokenAuth:
      type: http
      scheme: bearer
  parameters:
    id:
      name: id
      in: path
      description: ID
      schema:
        type: integer
        format: uint
  schemas:
    timestamp:
      type: integer
      format: int64
      description: unix second
